<MudSimpleTable Dense Elevation="3">
    <thead>
        <tr>
            <th>
                <MudTextField @bind-Value="Exercise.Name"
                              Label="Exercise Name"
                              Variant="Variant.Filled"
                              Margin="Margin.Dense" />
            </th>
            <th>Reps</th>
            <th>Weight</th>
            <th>
                <WorkoutTemplateExerciseMenu OnSetAdded="HandleSetAdded"
                                             OnRestTimerOpened="HandleRestTimerOpened"
                                             OnExerciseDeleted="HandleExerciseDeleted" />

                <WorkoutTemplateRestTimerMenu IsRestTimerOpen="@Exercise.IsRestTimerOpen"
                                              RestTimerValue="@Exercise.RestTimerValue"
                                              RestTimerUnit="@Exercise.RestTimerUnit"
                                              OnRestTimerUnitChanged="HandleRestTimerUnitChanged"
                                              OnRestTimerValueChanged="HandleRestTimerValueChanged"
                                              OnRestTimerCancel="HandleRestTimerCancel"
                                              OnRestTimerSet="HandleRestTimerSet" />
            </th>
        </tr>
    </thead>
    <tbody>
        @if (Exercise.Sets != null && Exercise.Sets.Any())
        {
            @for (int i = 0; i < Exercise.Sets.Count; i++)
            {
                var set = Exercise.Sets[i];

                <WorkoutTemplateSet Set="set" 
                                    SetIndex="i"
                                    OnSetDelete="HandleSetDelete" />
            }
        }
    </tbody>
</MudSimpleTable>

@code {
    [Parameter]
    public ExerciseTemplate Exercise { get; set; }

    [Parameter]
    public EventCallback<int> OnExerciseDeleted { get; set; }


    private void HandleSetAdded()
    {
        Exercise.Sets?.Add(new ExerciseTemplateSet 
            { 
                Id = Exercise.Sets.Any() ? Exercise.Sets.Max(s => s.Id) + 1 : 1,
                Reps = 10, 
                Weight = 0 
            });
    }

    private void HandleRestTimerValueChanged(int restTimerValue)
    {
        Exercise.RestTimerValue = restTimerValue;
    }

    private void HandleRestTimerOpened()
    {
        Exercise.IsRestTimerOpen = true;
    }

    private void HandleRestTimerUnitChanged(string restTimerUnit)
    {
        Exercise.RestTimerUnit = restTimerUnit;
    }

    private void HandleExerciseDeleted()
    {
        OnExerciseDeleted.InvokeAsync(Exercise.Id);
    }

    private void HandleRestTimerCancel()
    {
        Exercise.IsRestTimerOpen = false;
    }

    private void HandleRestTimerSet(int durationInSeconds)
    {
        Exercise.RestTimeBetweenSets = durationInSeconds;
        Exercise.IsRestTimerOpen = false;
    }

    private void HandleSetDelete(int setId)
    {
        if (Exercise.Sets.Count > 0)
        {
            var setToDelete = Exercise.Sets.FirstOrDefault(s => s.Id == setId);

            if (setToDelete != null)
            {
                Exercise.Sets.Remove(setToDelete);
            }
        }
    }
}