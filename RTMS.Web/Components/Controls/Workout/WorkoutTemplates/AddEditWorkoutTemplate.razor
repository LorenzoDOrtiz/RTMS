<MudStack Spacing="4">
    <WorkoutTemplateHeader WorkoutName="@_viewModel.Name"
                           OnWorkoutNameChanged="HandleWorkoutNameChange" />

    @if (_viewModel.Exercises != null && _viewModel.Exercises.Any())
    {
        foreach (var exercise in _viewModel.Exercises)
        {
            <WorkoutTemplateExercise Exercise="exercise"
                                     OnExerciseDeleted="HandleExerciseDeleted"
                                     OnExerciseNameChanged="RecalculateSaveDisabled" />
        }
    }

    <WorkoutTemplateButtons Exercises="_viewModel.Exercises"
                            OnSave="HandleValidation"
                            OnExerciseAdded="HandleExerciseAdded" 
                            IsSaveDisabled="IsSaveDisabled" />
</MudStack>

@code {
    private WorkoutTemplateViewModel _viewModel;

    [Parameter]
    public WorkoutTemplate WorkoutTemplate { get; set; }

    [Parameter]
    public bool IsForEdit { get; set; }

    [Parameter]
    public EventCallback OnValidationSuccess { get; set; }

    private bool IsSaveDisabled;

    protected override void OnInitialized()
    {
        InitializeViewModel();
    }

    private void InitializeViewModel()
    {
        _viewModel = new WorkoutTemplateViewModel
            {
                Name = WorkoutTemplate.Name,
                Exercises = WorkoutTemplate.Exercises.Select(e => new ExerciseTemplateViewModel
                {
                    Id = e.Id,
                    WorkoutTemplateId = WorkoutTemplate.Id,
                    Name = e.Name,
                    // Calculate value and unit based on the stored time in seconds
                    RestTimerValue = e.RestTimerValue,
                    RestTimerUnit = e.RestTimerUnit,
                    Sets = e.Sets.ToList(),
                    Note = e.Note
                }).ToList()
            };

        if (!IsForEdit)
        {
            HandleExerciseAdded();
        }

        RecalculateSaveDisabled();
    }

    private void HandleExerciseAdded()
    {
        _viewModel.Exercises.Add(new ExerciseTemplateViewModel
            {
                Id = _viewModel.Exercises.Any() ? _viewModel.Exercises.Max(w => w.Id) + 1 : 1,
                WorkoutTemplateId = _viewModel.Id,
                Name = "",
                Sets = new List<ExerciseTemplateSet>()
            {
                new ExerciseTemplateSet { Reps = 10, Weight = 0 }
            }
            });
        RecalculateSaveDisabled();
    }

    private void RecalculateSaveDisabled()
    {
        IsSaveDisabled = string.IsNullOrWhiteSpace(_viewModel.Name)
                         || _viewModel.Exercises.Any(e => string.IsNullOrWhiteSpace(e.Name));
    }

    private void HandleWorkoutNameChange(string newName)
    {
        _viewModel.Name = newName;
        RecalculateSaveDisabled();

    }

    private void HandleExerciseDeleted(int exerciseId)
    {
        var exerciseToDelete = _viewModel.Exercises.FirstOrDefault(e => e.Id == exerciseId);
        if (exerciseToDelete != null)
        {
            _viewModel.Exercises.Remove(exerciseToDelete);
        }
        RecalculateSaveDisabled();
    }

    private async Task HandleValidation()
    {
        // Perform validation before saving.
        if (IsSaveDisabled)
        {
            return; // Prevent save if validation fails.
        }
        else
        {
            // Update the actual model from the view model
            WorkoutTemplate.Name = _viewModel.Name;
            WorkoutTemplate.Exercises = _viewModel.Exercises.Select(e => new ExerciseTemplate
                {
                    Id = e.Id,
                    WorkoutTemplateId = e.WorkoutTemplateId,
                    Name = e.Name,
                    RestTimerValue = e.RestTimerValue,
                    RestTimerUnit = e.RestTimerUnit,
                    Sets = e.Sets.ToList(), 
                    Note = e.Note
                }).ToList();

            await OnValidationSuccess.InvokeAsync();
        }
    }
}
